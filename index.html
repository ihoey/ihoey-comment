<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Examples</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <link href="si.css" rel="stylesheet">
    <style>
    .comments {
        width: 800px;
        margin: 0 auto;
    }

    .logout {
        color: #777;
        display: none;
    }

    .ds-visitor-name {
        display: none;
    }
    </style>
</head>

<body>
    <div class="comments" id="comments">
        <div class="ds-thread" data-thread-key="links/index.html" data-title="友情链接" data-url="https://blog.ihoey.com/links/index.html" id="ds-thread">
            <div id="ds-reset">
                <div class="ds-meta"><a href="javascript:void(0)" class="ds-like-thread-button ds-rounded ds-thread-liked"><span class="ds-icon ds-icon-heart"></span> <span class="ds-thread-like-text">已喜欢</span><span class="ds-thread-cancel-like">取消喜欢</span></a><span class="ds-like-panel"><span class="ds-highlight">2</span> 人喜欢</span>
                </div>
                <div class="ds-toolbar">
                    <div class="ds-visitor logout">退出</div>
                    <div class="ds-visitor"><a class="ds-visitor-name" href="javascript:void(0);" target="_blank">匿名登录</a></div>
                    <div class="ds-visitor logup">
                        <a class="nm" href="javascript:void(0);" target="_blank">匿名登录</a>
                        <a class="qq" href="javascript:void(0);" target="_blank">QQ 登录</a>
                    </div>
                </div>
                <div class="ds-replybox">
                    <a class="ds-avatar" href="https://blog.ihoey.com" target="_blank" title="散场后的邂逅"><img src="https://q.qlogo.cn/qqapp/100229475/75185D13CBF9448D55D19FF064C38815/100" alt="散场后的邂逅"></a>
                    <!-- <form method="post"> -->
                    <div class="ds-textarea-wrapper ds-rounded-top">
                        <textarea name="message" title="Ctrl+Enter快捷提交" placeholder="......骚年哟，既然都来了，为何不吐槽几句呢 (σﾟ∀ﾟ)σ&quot;"></textarea><pre class="ds-hidden-text"></pre></div>
                    <div class="ds-post-toolbar">
                        <div class="ds-post-options ds-gradient-bg"></div>
                        <button class="ds-post-button" type="submit">发射!</button>
                    </div>
                    <!-- </form> -->
                </div>
                <ul class="ds-comments">
                    <li class="ds-post">
                        <div class="ds-post-self">
                            <div class="ds-avatar">
                                <img src="https://q.qlogo.cn/qqapp/100229475/75185D13CBF9448D55D19FF064C38815/100" alt="散场后的邂逅"></a>
                            </div>
                            <div class="ds-comment-body">
                                <div class="ds-comment-header"><a class="ds-user-name ds-highlight" href="https://blog.ihoey.com/">散场后的邂逅</a></div>
                                <p>哈哈，共勉</p>
                                <div class="ds-comment-footer ds-comment-actions">
                                    <span class="ds-time" title="2016年11月30日 15:33:02">2016年11月30日</span>
                                    <a class="ds-post-reply" href="javascript:void(0);">
                                        <span class="ds-icon ds-icon-reply"></span>回复
                                    </a>
                                    <a class="ds-post-likes" href="javascript:void(0);">
                                        <span class="ds-icon ds-icon-like"></span>顶
                                    </a>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="ds-post">
                        <div class="ds-post-self">
                            <div class="ds-avatar">
                                <img src="https://q.qlogo.cn/qqapp/100229475/75185D13CBF9448D55D19FF064C38815/100" alt="散场后的邂逅"></a>
                            </div>
                            <div class="ds-comment-body">
                                <div class="ds-comment-header"><a class="ds-user-name ds-highlight" href="https://blog.ihoey.com/">散场后的邂逅</a></div>
                                <p class="text">哈哈，共勉</p>
                                <div class="ds-comment-footer ds-comment-actions">
                                    <span class="ds-time" title="2016年11月30日 15:33:02">2016年11月30日</span>
                                    <a class="ds-post-reply" href="javascript:void(0);">
                                        <span class="ds-icon ds-icon-reply"></span>回复
                                    </a>
                                    <a class="ds-post-likes" href="javascript:void(0);">
                                        <span class="ds-icon ds-icon-like"></span>顶
                                    </a>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
                <div class="ex">
                    <li class="ds-post" style="display: none;">
                        <div class="ds-post-self">
                            <div class="ds-avatar">
                                <img src="https://q.qlogo.cn/qqapp/100229475/75185D13CBF9448D55D19FF064C38815/100" alt="散场后的邂逅"></a>
                            </div>
                            <div class="ds-comment-body">
                                <div class="ds-comment-header"><a class="ds-user-name ds-highlight" href="https://blog.ihoey.com/">散场后的邂逅</a></div>
                                <p class="text">哈哈，共勉</p>
                                <div class="ds-comment-footer ds-comment-actions">
                                    <span class="ds-time" title="2016年11月30日 15:33:02">2016年11月30日</span>
                                    <a class="ds-post-reply" href="javascript:void(0);">
                                        <span class="ds-icon ds-icon-reply"></span>回复
                                    </a>
                                    <a class="ds-post-likes" href="javascript:void(0);">
                                        <span class="ds-icon ds-icon-like"></span>顶
                                    </a>
                                </div>
                            </div>
                        </div>
                    </li>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.wilddog.com/sdk/js/2.5.8/wilddog.js"></script>
    <script>
    var host = window.location.hostname,
    url = window.location.host + window.location.pathname,
    title = window.document.title,

    var config = {
        authDomain: "ihoey.wilddog.com",
        syncURL: "https://ihoey.wilddogio.com"
    };
    wilddog.initializeApp(config);


    var provider = new wilddog.auth.QQAuthProvider();
    var auth = wilddog.auth();
    var ref = wilddog.sync().ref('/' + palindrome(host));
    ref.set({
        "full_name": "Steve Jobs",
        "gender": "male"
    });
    auth.onAuthStateChanged(function(user) {
        if (user != null) {
            $('.logup').hide();
            if (user.providerId != 'anonymous') {
                $('.ds-visitor-name').text(user.displayName);
                $('.ds-avatar img').attr('src', user.photoURL);
            } else {
                $('.ds-visitor-name').text('匿名用户');
                $('.ds-avatar img').attr('src', 'https://sponsor.ihoey.com/images/like.svg');
            };
            $('.logout').show();
            $('.ds-visitor-name').show();
        } else {
            $('.logout').hide();
        }
    });

    // 直接使用 signInWithRedirect 会造成重复登录。
    // QQ登录
    $('.qq').click(function() {
        auth.onAuthStateChanged(function(user) {
            if (user == null) {
                auth.signInWithRedirect(provider).then(function(user) {
                    console.log('登录了')
                }).catch(function(error) {
                    // 错误处理
                    console.log(error);
                    // ...
                });
            } else {
                console.log('已登录')
            }
        })
    })

    //匿名登录
    $('.nm').click(function() {
        wilddog.auth().signInAnonymously().then(function(user) {
            console.log(user);
        }).catch(function(error) {
            // 错误处理
            console.log(error);
            // ...
        })
    })

    //退出
    $('.logout').click(function() {
        auth.signOut().then(function() {
            // 退出成功
            window.location.reload()
        }).catch(function(error) {
            // 发生错误
            console.log("sign-out-error")
        });
    })

    $('.ds-like-thread-button').click(function() {
        $('.ds-highlight').eq(0).text(Number($('.ds-highlight').eq(0).text()) + 1)
    })

    //发布
    $('.ds-post-button').click(function() {
        if ($('.ds-textarea-wrapper textarea').val() != '') {
            var ex = $('.ex li').clone();
            var text = $('textarea').val();
            $('textarea').val('');
            var time = new Date().format("yyyy年MM月dd日");
            var photoURL = $('.ds-replybox .ds-avatar img').attr('src');
            var nickName = $('.ds-visitor-name').text();
            console.log(ex);
            console.log(ex.find('.ds-avatar img'))
            ex.find('.ds-avatar img').attr('src', photoURL);
            ex.find('.ds-user-name').text(nickName);
            ex.find('.ds-time').text(time);
            ex.find('.ds-comment-body .text').text(text);
            ex.show();
            $('.ds-comments').append(ex);
        } else {
            alert('你还没有输入内容！')
        }
    });



    Date.prototype.format = function(fmt) {
        var o = {
            "M+": this.getMonth() + 1,
            //月份
            "d+": this.getDate(),
            //日
            "h+": this.getHours() % 12 == 0 ? 12 : this.getHours() % 12,
            //小时
            "H+": this.getHours(),
            //小时
            "m+": this.getMinutes(),
            //分
            "s+": this.getSeconds(),
            //秒
            "q+": Math.floor((this.getMonth() + 3) / 3),
            //季度
            "S": this.getMilliseconds() //毫秒
        };
        var week = {
            "0": "\u65e5",
            "1": "\u4e00",
            "2": "\u4e8c",
            "3": "\u4e09",
            "4": "\u56db",
            "5": "\u4e94",
            "6": "\u516d"
        };
        if (/(y+)/.test(fmt)) {
            fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        }
        if (/(E+)/.test(fmt)) {
            fmt = fmt.replace(RegExp.$1, ((RegExp.$1.length > 1) ? (RegExp.$1.length > 2 ? "\u661f\u671f" : "\u5468") : "") + week[this.getDay() + ""]);
        }
        for (var k in o) {
            if (new RegExp("(" + k + ")").test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            }
        }
        return fmt;
    }

    function palindrome(str) {
        var newStr = str.toLowerCase().replace(/[^A-Za-z0-9]/g, "");
        return newStr;
    }
    </script>
</body>

</html>
